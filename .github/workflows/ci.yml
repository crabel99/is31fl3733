name: CI

on:
  push:
  pull_request:

jobs:
  compile-examples:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - fqbn: adafruit:samd:adafruit_feather_m0
            core: adafruit:samd
            additional_urls: https://adafruit.github.io/arduino-board-index/package_adafruit_index.json
          - fqbn: adafruit:samd:adafruit_metro_m0
            core: adafruit:samd
            additional_urls: https://adafruit.github.io/arduino-board-index/package_adafruit_index.json
          - fqbn: adafruit:samd:adafruit_feather_m4
            core: adafruit:samd
            additional_urls: https://adafruit.github.io/arduino-board-index/package_adafruit_index.json
          - fqbn: adafruit:samd:adafruit_metro_m4
            core: adafruit:samd
            additional_urls: https://adafruit.github.io/arduino-board-index/package_adafruit_index.json
          - fqbn: arduino:sam:arduino_due_x
            core: arduino:sam
          - fqbn: teensy:avr:teensy41
            core: teensy:avr
            additional_urls: https://www.pjrc.com/teensy/package_teensy_index.json
    steps:
      - uses: actions/checkout@v4
      - uses: arduino/setup-arduino-cli@v1
      - name: Install core (with retries and fallback)
        shell: bash
        run: |
          set -e
          MAX_RETRIES=3
          RETRY_DELAY=10
          
          install_core() {
            local urls="$1"
            local core="$2"
            local attempt=1
            
            while [ $attempt -le $MAX_RETRIES ]; do
              echo "Attempt $attempt/$MAX_RETRIES for core $core"
              if [ -n "$urls" ]; then
                echo "  Using additional URLs: $urls"
                if timeout 120 arduino-cli core update-index --additional-urls "$urls" 2>&1 | tee /tmp/index.log; then
                  if timeout 180 arduino-cli core install "$core" 2>&1; then
                    echo "  Successfully installed $core"
                    return 0
                  fi
                fi
              else
                if timeout 120 arduino-cli core update-index 2>&1 | tee /tmp/index.log; then
                  if timeout 180 arduino-cli core install "$core" 2>&1; then
                    echo "  Successfully installed $core"
                    return 0
                  fi
                fi
              fi
              
              echo "  Failed to install $core (attempt $attempt/$MAX_RETRIES)"
              cat /tmp/index.log || true
              
              if [ $attempt -lt $MAX_RETRIES ]; then
                echo "  Retrying in ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
              fi
              attempt=$((attempt + 1))
            done
            
            echo "  WARNING: Failed to install core $core after $MAX_RETRIES attempts, skipping..."
            return 0  # Don't fail the job, continue with other boards
          }
          
          # Install core with retry logic
          install_core "${{ matrix.additional_urls }}" "${{ matrix.core }}"
      
      - name: Create library symlink
        run: |
          mkdir -p ~/Arduino/libraries
          ln -s ${{ github.workspace }} ~/Arduino/libraries/IS31FL3733
      
      - uses: arduino/compile-sketches@v1
        continue-on-error: true
        with:
          fqbn: ${{ matrix.fqbn }}
          sketch-paths: |
            examples/abm_arduino
            examples/rgb_matrix_arduino

  clang-format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format
      - name: Format check
        run: clang-format --Werror --dry-run src/*.hpp src/*.cpp

  platformio-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: ~/.platformio
          key: ${{ runner.os }}-${{ hashFiles('**/lockfiles') }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade platformio

      - name: Run PlatformIO native tests
        run: pio test -e native -v
  documentation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Doxygen
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz
      - name: Generate Doxygen documentation
        run: doxygen Doxyfile
      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: doxygen-documentation
          path: html/