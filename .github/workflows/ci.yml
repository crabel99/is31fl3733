name: CI

on:
  push:
  pull_request:

jobs:
  compile-examples:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade platformio
      - name: Prepare SimIO framework package (sercom-async-dma)
        run: |
          rm -rf /tmp/simiofw-ci
          git clone --depth 1 --branch sercom-async-dma --recurse-submodules https://github.com/crabel99/SimIOFramework /tmp/simiofw-ci
          git -C /tmp/simiofw-ci submodule update --init --recursive
          cat > /tmp/simiofw-ci/package.json <<'EOF'
          {
            "name": "framework-arduino-samd-adafruit",
            "version": "1.0.0",
            "description": "SimIO Arduino SAMD framework with async SERCOM DMA extensions",
            "keywords": ["framework", "arduino", "samd", "simio"],
            "homepage": "https://github.com/crabel99/SimIOFramework",
            "license": "LGPL-2.1-or-later",
            "system": ["linux_x86_64"],
            "platforms": ["atmelsam"]
          }
          EOF
      - name: Compile Arduino examples (PlatformIO + SimIO framework)
        run: |
          set -euo pipefail

          BUILD_BOARDS=$(python - <<'PY'
          import sys
          simio = set()
          with open('/tmp/simiofw-ci/boards.txt', 'r', encoding='utf-8') as f:
              for line in f:
                  if line.strip().startswith('#') or '.name=' not in line:
                      continue
                  key = line.split('.name=', 1)[0].strip()
                  if key and key.replace('_', '').isalnum() and key.lower() == key:
                      simio.add(key)

          import json, subprocess
          out = subprocess.check_output(
              ['pio', 'boards', '--json-output', 'atmelsam'],
              text=True,
          )
          pio = {item['id'] for item in json.loads(out)}

          common = sorted(simio & pio)
          missing = sorted(simio - pio)

          print(' '.join(common))
          if missing:
              print('Missing in PlatformIO atmelsam: ' + ', '.join(missing), file=sys.stderr)
          PY
          )

          if [ -z "$BUILD_BOARDS" ]; then
            echo "No SimIO-supported boards available in PlatformIO atmelsam."
            exit 1
          fi

          echo "Building examples for boards: $BUILD_BOARDS"

          for board in $BUILD_BOARDS; do
            echo "=== Building board: $board (abm_arduino) ==="
            pio ci \
              --board "$board" \
              --lib=. \
              --project-option=platform=atmelsam \
              --project-option=framework=arduino \
              --project-option=build_flags=-DUSE_TINYUSB \
              --project-option=platform_packages=framework-arduino-samd-adafruit@symlink:///tmp/simiofw-ci \
              examples/abm_arduino/abm_arduino.ino

            echo "=== Building board: $board (rgb_matrix_arduino) ==="
            pio ci \
              --board "$board" \
              --lib=. \
              --project-option=platform=atmelsam \
              --project-option=framework=arduino \
              --project-option=build_flags=-DUSE_TINYUSB \
              --project-option=platform_packages=framework-arduino-samd-adafruit@symlink:///tmp/simiofw-ci \
              examples/rgb_matrix_arduino/rgb_matrix_arduino.ino
          done

  clang-format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format
      - name: Format check
        run: clang-format --Werror --dry-run src/*.hpp src/*.cpp

  platformio-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: ~/.platformio
          key: ${{ runner.os }}-${{ hashFiles('**/lockfiles') }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade platformio

      - name: Run PlatformIO native tests
        run: pio test -e native -v
  documentation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Doxygen
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz
      - name: Generate Doxygen documentation
        run: doxygen Doxyfile
      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: doxygen-documentation
          path: html/