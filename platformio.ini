; PlatformIO Test Configuration File
;
; ⚠️ EXPERIMENTAL ASYNC DRIVER - REQUIRES CUSTOM SIMIOFRAMEWORK
; This driver requires the async DMA branch of SimIOFramework:
; https://github.com/crabel99/SimIOFramework/tree/sercom-async-dma
;
; This project uses two test environments:
; - embedded: runs on Adafruit Feather M0 hardware via J-Link (test_embedded)
;             Uses custom Wire1 on SERCOM1 (PA16/PA17) configured in test code
;             Pin mappings in test/test_embedded/basic/is31fl3733_pins.h must match your wiring
; - native: runs on host with mocks (test_native)
;
; Shared test libraries and flags live in [common].
; Each environment adds its own libraries, flags, and include paths.
[platformio]
; No custom board definitions needed - using standard Adafruit Feather M0
; Wire/SERCOM configuration is done in test code for hardware-specific setup

; Common build flags for both native and embedded tests
[common]
lib_deps =
	https://github.com/crabel99/DebugUtils
	https://github.com/crabel99/Unity#platformio-compat
build_flags =
	-std=gnu++17
	-DUNIT_TEST
	-D_DEBUG_
	-DUNITY_INCLUDE_CONFIG_H
	-DUNITY_OUTPUT_VERBOSE
	-Wno-ignored-qualifiers

; Native host tests (mocked Arduino/Wire) - CI compatible
[env:native]
platform = native
; test_framework = unity
test_build_src = true
test_filter = test_native
test_ignore = test_embedded
lib_compat_mode = off
; lib_ignore = Unity
lib_deps = ${common.lib_deps}
build_flags =
	${common.build_flags}
	-DNATIVE_TEST
	-Itest/test_native
	-Itest/test_native/mocks

; Embedded hardware tests (SerialRTT output, J-Link upload)
; Uses standard Feather M0 board, SERCOM/pins configured in test code
; Note: Pin assignments differ from SimIO M0 as PA22/PA23 are not available on Feather M0
[env:embedded]
platform = atmelsam
board = adafruit_feather_m0
framework = arduino
platform_packages =
    framework-arduino-samd-simio@https://github.com/crabel99/SimIOFramework#sercom-async-dma
monitor_speed = 115200
upload_protocol = jlink
debug_tool = jlink
test_framework = unity
test_build_src = true
test_filter = test_embedded
test_ignore = test_native
test_port = socket://localhost:19021
extra_scripts = pre:${PROJECT_LIBDEPS_DIR}/embedded/SerialRTT/scripts/pre_test.py
lib_ignore = Unity
lib_deps =
	https://github.com/crabel99/DebugUtils
	https://github.com/crabel99/SerialRTT
build_type = debug
build_flags =
	${common.build_flags}
	-DUSE_ZERODMA
	-DUSE_TINYUSB
	-DSERCOM_STRICT_PAD
	-Itest/test_embedded
	-DBUFFER_SIZE_UP=8192
	-DSERIALRTT_USE_SKIP_NO_LOCK
