; PlatformIO Test Configuration File
;
; ⚠️ EXPERIMENTAL ASYNC DRIVER - REQUIRES CUSTOM SIMIOFRAMEWORK
; This driver requires the async DMA branch of SimIOFramework:
; https://github.com/crabel99/SimIOFramework/tree/sercom-async-dma
;
; This project uses two test environments:
; - embedded: runs on SimIO_Device_M0 hardware via J-Link (test_embedded). Use this as a template for your own hardware tests.
; - native: runs on host with mocks (test_native)
;
; Shared test libraries and flags live in [common].
; Each environment adds its own libraries, flags, and include paths.
[platformio]
boards_dir = ../SimIO/SimIODevice/boards

; Common libraries/flags for both native and embedded tests
[common]
lib_deps =
	symlink://../SimIO/Core/DebugUtils
	symlink://../Unity
build_flags =
	-std=gnu++17
	-DUNIT_TEST
	-D_DEBUG_
	-DUNITY_INCLUDE_CONFIG_H
	-DUNITY_OUTPUT_VERBOSE
	-Wno-ignored-qualifiers

; Native host tests (mocked Arduino/Wire)
[env:native]
platform = native
test_framework = unity
test_build_src = true
test_filter = test_native
test_ignore = test_embedded
lib_compat_mode = off
lib_ignore = Unity
lib_deps = ${common.lib_deps}
build_flags =
	${common.build_flags}
	-DNATIVE_TEST
	-Itest/test_native
	-Itest/test_native/mocks

; Embedded hardware tests (SerialRTT output, J-Link upload)
[env:embedded]
platform = atmelsam
board = SimIO_Device_M0
framework = arduino
platform_packages = framework-arduino-samd-simio@symlink://../SimIO/SimIOFramework
monitor_speed = 115200
upload_protocol = jlink
debug_tool = jlink
test_framework = unity
test_build_src = true
test_filter = test_embedded
test_ignore = test_native
test_port = socket://localhost:19021
extra_scripts = pre:../SerialRTT/scripts/pre_test.py
lib_ignore = Unity
lib_deps =
	${common.lib_deps}
	symlink://../SerialRTT
build_type = debug
build_flags =
	${common.build_flags}
	-DUSE_ZERODMA
	-DUSE_TINYUSB
	-DSERCOM_STRICT_PAD
	-Itest/test_embedded
	-DBUFFER_SIZE_UP=8192
	-DSERIALRTT_USE_SKIP_NO_LOCK
